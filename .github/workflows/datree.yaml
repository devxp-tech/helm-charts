name: Datree 🔎
on:
  workflow_dispatch:
  push:
    # branches: [ main ]

env:
  DATREE_TOKEN: ${{ secrets.DATREE_TOKEN }}

jobs:
  datree:
    name: Validate Helm charts 🔒
    runs-on: ubuntu-latest
    container:
      image: dtzar/helm-kubectl:3.6.3
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      # - name: Install Datree 🔨
      #   run: |
      #     helm plugin install https://github.com/datreeio/helm-datree
      # - name: Datree test 🔥
      #   env:
      #     DATREE_TOKEN: ${{ secrets.DATREE_TOKEN }}
      #   run: |
      #     helm datree test ./charts/tooling --ignore-missing-schemas

      - name: Run Datree Policy Check
        uses: datreeio/action-datree@main
        with:
          path: './charts/devxp-app'
          cliArguments: '-o sarif'
          isHelmChart: true
          helmArguments: '--set name=ci'

      - name: Upload analysis results to GitHub
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: datree.sarif
          wait-for-processing: true