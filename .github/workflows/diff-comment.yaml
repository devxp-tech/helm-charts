name: Diff Comment 🤖

on:
  workflow_dispatch:
  issues:
    types: [opened, reopened]
  pull_request:
    types: [opened, reopened]

jobs:
  helm-diff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
    - name: Checkout 🛎️
      uses: actions/checkout@v4
      with:
        ref: main
        path: main_branch

    - name: Generate Results from Main
      run: |
        cd main_branch/charts/devxp-app
        helm template . -f values-ci.yaml > ../result.yaml

        #for p in $(ls -l charts | awk '{print $9}'); do helm template charts/$p -f charts/$p/values-ci.yaml > charts/$p/results.yaml ; done

    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        path: pr_branch

    - name: Run helm template on PR branch
      run: |
        cd pr_branch/charts/devxp-app
        helm template . -f values-ci.yaml > ../result_new.yaml

    - name: Install yq for YAML comparison
      run: sudo apt-get install -y yq

    - name: Compare YAML files
      run: |
        diff_output=$(diff -u result.yaml result_new.yaml || true)
        echo "$diff_output" > diff.txt

    - name: Comment diff on PR
      if: success()
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        path: diff.txt
        token: ${{ secrets.GITHUB_TOKEN }}